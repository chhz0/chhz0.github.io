<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Redis - Encoding&lt;HashTable> | ch.hugo</title>
<link rel=icon href=favicon.svg sizes=any type=image/svg+xml><meta property="og:url" content="https://chhz0.github.io/notes/database/redis/datatypes/encoding/hashtable/"><meta property="og:site_name" content="ch.hugo"><meta property="og:title" content="Redis - Encoding"><meta property="og:description" content="Redis< enc-HashTable > HASHTABLE可以使用O(1)时间复杂度能够快速找到field对应的value，简单理解，HASHTABLE是一个目录，可以帮助我们快速找到需要内容
HASHTABLE的结构:
typedef struct dictht { dictEntry **table; unsigned long size; unsigned long sizemask; unsigned long used; } dictht; 最外层封装一个dictht结构，字段含义如下：
Table: 指向实际hash存储。存储可以看做一个数组 Size: 哈希表大小，实际就是dictEntry有多少元素空间 Sizemask: 哈希表大小的掩码表示，总是等于size-1. 这个属性和哈希值一起决定一个键应该放到table数组的那个索引上面，规则 Index = hash & sizemask. Used: 表示已经使用的节点数量。通过这个字段可以查询目前HASHTABLE元素总量 dictEntry结构如下：
typedef struct dictEntry { void *key; union { void *val; uint64_t u64; int64_t s64; double d; } v; struct dictEntry *next; void *metadata[]; } dictEntry; Hash 渐进式扩容/缩容 扩容 渐进式扩容就是一点一点扩大HASHTABLE的容量，默认值为4 (#define DICT_HT_INTTIAL_SIZE 4) 为了实现渐进式扩容，Redis没有直接把dictht暴露给上层，而是再封装了一层
typedef struct dict { dictType *type; void *privdata; dictht ht[2]; long rehashidx; unsigned long iterators; } dict; dict结构里面，包含了2个dictht结构，也就是2个HASHTABLE结构。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="notes"><meta property="article:published_time" content="2025-06-10T22:36:08+08:00"><meta property="article:modified_time" content="2025-06-10T22:36:08+08:00"><meta property="article:tag" content="Redis"><meta name=twitter:card content="summary"><meta name=twitter:title content="Redis - Encoding"><meta name=twitter:description content="Redis< enc-HashTable > HASHTABLE可以使用O(1)时间复杂度能够快速找到field对应的value，简单理解，HASHTABLE是一个目录，可以帮助我们快速找到需要内容
HASHTABLE的结构:
typedef struct dictht { dictEntry **table; unsigned long size; unsigned long sizemask; unsigned long used; } dictht; 最外层封装一个dictht结构，字段含义如下：
Table: 指向实际hash存储。存储可以看做一个数组 Size: 哈希表大小，实际就是dictEntry有多少元素空间 Sizemask: 哈希表大小的掩码表示，总是等于size-1. 这个属性和哈希值一起决定一个键应该放到table数组的那个索引上面，规则 Index = hash & sizemask. Used: 表示已经使用的节点数量。通过这个字段可以查询目前HASHTABLE元素总量 dictEntry结构如下：
typedef struct dictEntry { void *key; union { void *val; uint64_t u64; int64_t s64; double d; } v; struct dictEntry *next; void *metadata[]; } dictEntry; Hash 渐进式扩容/缩容 扩容 渐进式扩容就是一点一点扩大HASHTABLE的容量，默认值为4 (#define DICT_HT_INTTIAL_SIZE 4) 为了实现渐进式扩容，Redis没有直接把dictht暴露给上层，而是再封装了一层
typedef struct dict { dictType *type; void *privdata; dictht ht[2]; long rehashidx; unsigned long iterators; } dict; dict结构里面，包含了2个dictht结构，也就是2个HASHTABLE结构。"><link rel=stylesheet href=/css/components.min.9d886688d3ae94cecf1b057e706bf74497fcd5cea352d433c34cda3b9425a8d4.css integrity="sha256-nYhmiNOulM7PGwV+cGv3RJf81c6jUtQzw0zaO5QlqNQ=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.17813e97a146cc70fc6064666a89082f1ef2f6213c7d3fade88402a86cf8aa3c.css integrity="sha256-F4E+l6FGzHD8YGRmaokILx7y9iE8fT+t6IQCqGz4qjw=" crossorigin=anonymous><link rel=stylesheet href=/css/root.min.1677bc99f2421f7cb9fc1d00b09addcc951fd9d4c785e22b20ed55c0602786fc.css integrity="sha256-Fne8mfJCH3y5/B0AsJrdzJUf2dTHheIrIO1VwGAnhvw=" crossorigin=anonymous><link rel=stylesheet href=/css/search.min.cb1ed1dad3ee872e229e9f1fc681bdbd20d923389f1fa6aaf89f9aee93af4fbf.css integrity="sha256-yx7R2tPuhy4inp8fxoG9vSDZIzifH6aq+J+a7pOvT78=" crossorigin=anonymous><link rel=stylesheet href=/css/bundle.min.4878d16c866148ae8cfd6f4f44052d25f2548b24ab4a9bc857279dc6d06df2b5.css integrity="sha256-SHjRbIZhSK6M/W9PRAUtJfJUiySrSpvIVyedxtBt8rU=" crossorigin=anonymous><script src=/js/bundle.995e4ec99401021e081ec256bee66154ef7f4e5136809432513b2e6d014b4b1d.js integrity="sha256-mV5OyZQBAh4IHsJWvuZhVO9/TlE2gJQyUTsubQFLSx0=" crossorigin=anonymous></script><script defer src=/js/search/flexsearch.compact.64594b125f7b78bdf4fa8316955922bbebb1cd6baef3f16654bfca20309f18f8.js integrity="sha256-ZFlLEl97eL30+oMWlVkiu+uxzWuu8/FmVL/KIDCfGPg="></script><script defer src=/js/search/search.1d980f84df11f3eb7c8c5f17f541d49a0611608df179dd74fa7f06225eb56ace.js integrity="sha256-HZgPhN8R8+t8jF8X9UHUmgYRYI3xed10+n8GIl61as4="></script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel=stylesheet></head><body class=notransition><div id=container><header id=main-header><div role=navigation aria-label=Main><div class=nav-left><a href=https://chhz0.github.io/ style=color:inherit>ch.hugo</a></div><div class=nav-right><div style=position:absolute;width:0;height:0><div id=nav-dropdown-menu class=hidden href=#><div class=nav-item><a href=/blogs/>博客</a></div><div class=nav-item><a aria-current=true class=ancestor href=/notes/>笔记</a></div><div class=nav-item><a href=/about/>关于</a></div></div></div><a id=nav-dropdown-button href=#><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4 6H20M4 12H20M4 18H20" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></a><div id=nav-menu><div class=nav-item><a href=/blogs/>博客</a></div><div class=nav-item><a aria-current=true class=ancestor href=/notes/>笔记</a></div><div class=nav-item><a href=/about/>关于</a></div></div><a id=theme-switcher href=#><svg class="light-icon" viewBox="0 0 24 24" fill="none"><path d="M12 3V4m0 16v1M4 12H3M6.31412 6.31412 5.5 5.5m12.1859.81412L18.5 5.5M6.31412 17.69 5.5 18.5001M17.6859 17.69 18.5 18.5001M21 12H20m-4 0c0 2.2091-1.7909 4-4 4-2.20914.0-4-1.7909-4-4 0-2.20914 1.79086-4 4-4 2.2091.0 4 1.79086 4 4z" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
<svg class="dark-icon" viewBox="0 0 24 24" fill="none"><path d="M3.32031 11.6835c0 4.9706 4.02944 9 8.99999 9 3.7872.0 7.028-2.3392 8.3565-5.6515C19.6402 15.4486 18.5059 15.6834 17.3203 15.6834c-4.9706.0-8.99999-4.0294-8.99999-8.99998C8.32031 5.50338 8.55165 4.36259 8.96453 3.32996 5.65605 4.66028 3.32031 7.89912 3.32031 11.6835z" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
</a>|
<a id=theme-switcher href=https://github.com/chhz0 aria-label=GitHub><svg class="light-icon" width="800" height="800" viewBox="0 0 20 20" xmlns:xlink="http://www.w3.org/1999/xlink"><title>github [#142]</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Dribbble-Light-Preview" transform="translate(-140.000000, -7559.000000)" fill="#fff"><g id="icons" transform="translate(56.000000, 160.000000)"><path d="M94 7399C99.523 7399 104 7403.59 104 7409.253 104 7413.782 101.138 7417.624 97.167 7418.981 96.66 7419.082 96.48 7418.762 96.48 7418.489 96.48 7418.151 96.492 7417.047 96.492 7415.675 96.492 7414.719 96.172 7414.095 95.813 7413.777 98.04 7413.523 100.38 7412.656 100.38 7408.718 100.38 7407.598 99.992 7406.684 99.35 7405.966 99.454 7405.707 99.797 7404.664 99.252 7403.252 99.252 7403.252 98.414 7402.977 96.505 7404.303 95.706 7404.076 94.85 7403.962 94 7403.958 93.15 7403.962 92.295 7404.076 91.497 7404.303 89.586 7402.977 88.746 7403.252 88.746 7403.252 88.203 7404.664 88.546 7405.707 88.649 7405.966 88.01 7406.684 87.619 7407.598 87.619 7408.718 87.619 7412.646 89.954 7413.526 92.175 7413.785 91.889 7414.041 91.63 7414.493 91.54 7415.156 90.97 7415.418 89.522 7415.871 88.63 7414.304 88.63 7414.304 88.101 7413.319 87.097 7413.247 87.097 7413.247 86.122 7413.234 87.029 7413.87 87.029 7413.87 87.684 7414.185 88.139 7415.37 88.139 7415.37 88.726 7417.2 91.508 7416.58 91.513 7417.437 91.522 7418.245 91.522 7418.489 91.522 7418.76 91.338 7419.077 90.839 7418.982 86.865 7417.627 84 7413.783 84 7409.253 84 7403.59 88.478 7399 94 7399" id="github-[#142]"/></g></g></g></svg><svg class="dark-icon" width="800" height="800" viewBox="0 0 20 20" xmlns:xlink="http://www.w3.org/1999/xlink"><title>github [#142]</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Dribbble-Light-Preview" transform="translate(-140.000000, -7559.000000)" fill="#000"><g id="icons" transform="translate(56.000000, 160.000000)"><path d="M94 7399C99.523 7399 104 7403.59 104 7409.253 104 7413.782 101.138 7417.624 97.167 7418.981 96.66 7419.082 96.48 7418.762 96.48 7418.489 96.48 7418.151 96.492 7417.047 96.492 7415.675 96.492 7414.719 96.172 7414.095 95.813 7413.777 98.04 7413.523 100.38 7412.656 100.38 7408.718 100.38 7407.598 99.992 7406.684 99.35 7405.966 99.454 7405.707 99.797 7404.664 99.252 7403.252 99.252 7403.252 98.414 7402.977 96.505 7404.303 95.706 7404.076 94.85 7403.962 94 7403.958 93.15 7403.962 92.295 7404.076 91.497 7404.303 89.586 7402.977 88.746 7403.252 88.746 7403.252 88.203 7404.664 88.546 7405.707 88.649 7405.966 88.01 7406.684 87.619 7407.598 87.619 7408.718 87.619 7412.646 89.954 7413.526 92.175 7413.785 91.889 7414.041 91.63 7414.493 91.54 7415.156 90.97 7415.418 89.522 7415.871 88.63 7414.304 88.63 7414.304 88.101 7413.319 87.097 7413.247 87.097 7413.247 86.122 7413.234 87.029 7413.87 87.029 7413.87 87.684 7414.185 88.139 7415.37 88.139 7415.37 88.726 7417.2 91.508 7416.58 91.513 7417.437 91.522 7418.245 91.522 7418.489 91.522 7418.76 91.338 7419.077 90.839 7418.982 86.865 7417.627 84 7413.783 84 7409.253 84 7403.59 88.478 7399 94 7399" id="github-[#142]"/></g></g></g></svg></a></div></div></header><div class="flex grow"><div id=main-pane><main id=main-content><div class=single-header><ol class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=https://chhz0.github.io/><span itemprop=name>Home</span>
</a><meta itemprop=position content='1'></li><span>&nbsp»&nbsp</span><li itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=https://chhz0.github.io/notes/><span itemprop=name>Notes</span>
</a><meta itemprop=position content='2'></li><span>&nbsp»&nbsp</span><li itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=https://chhz0.github.io/notes/database/><span itemprop=name>Database</span>
</a><meta itemprop=position content='3'></li><span>&nbsp»&nbsp</span><li itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=https://chhz0.github.io/notes/database/redis/><span itemprop=name>Redis</span>
</a><meta itemprop=position content='4'></li><span>&nbsp»&nbsp</span><li itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=https://chhz0.github.io/notes/database/redis/datatypes/><span itemprop=name>Redis - Datatypes</span>
</a><meta itemprop=position content='5'></li><span>&nbsp»&nbsp</span><li itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=https://chhz0.github.io/notes/database/redis/datatypes/encoding/><span itemprop=name>Redis - Encoding</span>
</a><meta itemprop=position content='6'></li><span>&nbsp»&nbsp</span></ol><h1>Redis - Encoding&lt;HashTable></h1><time class=dim datetime=2025-06-10T22:36:08+08:00>June 10, 2025</time><div class=term-container><div class=tag><a href=https://chhz0.github.io/tags/redis/>#Redis</a></div></ol></div><section class=page-section><h2 id=redis-enc-hashtable->Redis&lt; enc-HashTable ></h2><p><code>HASHTABLE</code>可以使用O(1)时间复杂度能够快速找到<code>field</code>对应的<code>value</code>，简单理解，<code>HASHTABLE</code>是一个目录，可以帮助我们快速找到需要内容</p><p><code>HASHTABLE</code>的结构:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> dictht {
</span></span><span style=display:flex><span>    dictEntry <span style=color:#f92672>**</span>table;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> size;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> sizemask;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> used;
</span></span><span style=display:flex><span>} dictht;
</span></span></code></pre></div><p>最外层封装一个<code>dictht</code>结构，字段含义如下：</p><ul><li><code>Table</code>: 指向实际hash存储。存储可以看做一个数组</li><li><code>Size</code>: 哈希表大小，实际就是dictEntry有多少元素空间</li><li><code>Sizemask</code>: 哈希表大小的掩码表示，总是等于size-1. 这个属性和哈希值一起决定一个键应该放到table数组的那个索引上面，规则 <strong>Index = hash & sizemask</strong>.</li><li><code>Used</code>: 表示已经使用的节点数量。通过这个字段可以查询目前HASHTABLE元素总量</li></ul><p><code>dictEntry</code>结构如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> dictEntry {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>key;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>union</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>val;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>uint64_t</span> u64;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>int64_t</span> s64;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>double</span> d;
</span></span><span style=display:flex><span>    } v;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> dictEntry <span style=color:#f92672>*</span>next;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>metadata[];
</span></span><span style=display:flex><span>} dictEntry;
</span></span></code></pre></div><p><img src=/redis/redis-encoding-hashtable-struct.drawio.svg alt=redis-encodng-hashtable-struct></p><h3 id=hash-渐进式扩容缩容>Hash 渐进式扩容/缩容</h3><h4 id=扩容>扩容</h4><p>渐进式扩容就是一点一点扩大<code>HASHTABLE</code>的容量，默认值为4 (#define DICT_HT_INTTIAL_SIZE 4)
为了实现渐进式扩容，Redis没有直接把dictht暴露给上层，而是再封装了一层</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> dict {
</span></span><span style=display:flex><span>    dictType <span style=color:#f92672>*</span>type;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>privdata;
</span></span><span style=display:flex><span>    dictht ht[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>long</span> rehashidx;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> iterators;
</span></span><span style=display:flex><span>} dict;
</span></span></code></pre></div><p><code>dict</code>结构里面，包含了2个dictht结构，也就是2个HASHTABLE结构。</p><p><code>dictEntry</code>是链表结构，用拉链法解决Hash冲突，用的是头插法</p><p>实际上，平时使用的时候就是一个<code>HASHTABLE</code>，在触发扩容之后，就会有两个<code>HASHTABLE</code>同时使用，详细过程如下：
当向字典添加元素时，需要扩容时会进行<code>rehash</code></p><p>::: info Rehash流程分以下三步：</p><ol><li>为新Hash表ht[1]分配空间，新表大小为第一个大于等于原表ht[0]的2倍used的2次幂。例如，原表used=500，2*used=1000，第一个大于1000的2次幂为1024，因此新表的大小为1024. 此时，字典同时持有ht[0]和ht[1]两个哈希表，字典的偏移索引rehashidx从静默状态-1，设置为0，表示Rehash正式开始工作。</li><li>迁移ht[0]数据到ht[1]在Rehash进行期间，每次对字典执行增删改查操作，程序会顺带迁移当前rehashidx在ht[0]上的对应数据，并更新偏移索引(rehashidx)。</li><li>随着字典操作的不断执行，最终在某个节点，ht[0]的所有键值对会被Rehash到ht[1]，此时再将ht[1]和ht[0]两个指针对象互换，同时把偏移索引的值设置为-1，表示Rehash操作已经完成。
小总结：渐进式扩容的核心是操作时顺带迁移
:::</li></ol><h4 id=扩容时机>扩容时机</h4><p>redis提出一个负载因子的概念，负载因子表示目前Redis HASHTABLE的负载情况</p><p>用k表示负载因子：<code>k=ht[0].used/ht[0].size</code>，也就是使用空间和总空间大小的比例，redis会根据负载因子的情况来扩容：</p><ol><li>负载因子 <strong>k大于1</strong> 时，说明此时空间非常紧张，新数据在链表上叠加，越来越多的数据导致查询无法在O(1)时间复杂度找到，还要遍历链表，如果此时服务器没有执行BGSAVE或BGREWRITEAOF两个命令，就会发生扩容。</li><li>负载因子 <strong>k大于5</strong> 时，说明HASHTABLE已经不堪重负，此时即使有复制命令在，也要进行扩容</li></ol><h4 id=缩容>缩容</h4><p>当有了多余的空间，如果不释放，就会导致多余的空间被浪费</p><p>缩容过程和扩容是相似的，也是渐进式缩容，同样缩容时机也是用负载因子来控制的</p><p>当负载因子小于0.1，此时进行缩容，新表的大小为第一个大于等于used的2次幂</p><p>使用<code>BGSAVE</code>或<code>BGREWRITEAOF</code>两个复制命令，缩容也会受影响，不会进行</p></section></main><footer id=main-footer><div class=footer><a href=#>回到顶部 ↑</a><div class=footer-copyright><div>© 2025 Chen-Hang</div><div>powered by <a href=https://github.com/math-queiroz/rusty-typewriter target=_blank>Rusty Typewriter</a> theme for <a href=https://gohugo.io/ target=_blank>Hugo</a></div></div></div></footer></div><aside id=side-pane class=side-sticky><div class=side-details><span>961 字数</span>
<span>3 - 4 阅读时间</span><div class=side-details-taxonomy><small>categories:
<span class=details-taxonomy><a href=https://chhz0.github.io/categories/note>Note</a></span></small></div></div><h3>目录</h3><nav id=TableOfContents><ul><li><a href=#redis-enc-hashtable->Redis&lt; enc-HashTable ></a><ul><li><a href=#hash-渐进式扩容缩容>Hash 渐进式扩容/缩容</a></li></ul></li></ul></nav><h3>相关</h3><ul><li><a href=/notes/database/redis/datatypes/encoding/skiplist/>Redis - Encoding&lt;SkipList></a></li><li><a href=/notes/database/redis/datatypes/encoding/ziplist/>Redis - Encoding&lt;ZipList></a></li><li><a href=/notes/database/redis/datatypes/encoding/sds/>Redis - Encoding&lt;sds></a></li><li><a href=/notes/database/redis/datatypes/hash/>Redis - Hash</a></li><li><a href=/notes/database/redis/datatypes/list/>Redis - List</a></li></ul></aside></div></div></body></html>